! *****************************COPYRIGHT*******************************
! (C) Crown copyright Met Office. All rights reserved.
! For further details please refer to the file COPYRIGHT.txt
! which you should have received as part of this distribution.
! *****************************COPYRIGHT*******************************
!
! Description:
!  To perform a chemical integration using the Backward Euler
!  Solver from the STOCHEM model
!
!  Part of the UKCA model, a community model supported by the
!  Met Office and NCAS, with components provided initially
!  by The University of Cambridge, University of Leeds and
!  The Met. Office.  See www.ukca.ac.uk
!
! Method:
!
! Code Owner: Please refer to the UM file CodeOwners.txt
! This file belongs in section: UKCA
!
!  Code Description:
!   Language:  FORTRAN 90
!   This code is written to UMDP3 v6 programming standards.
!
! ----------------------------------------------------------------------
!
MODULE ukca_deriv_mod

IMPLICIT NONE

CHARACTER(LEN=*), PARAMETER, PRIVATE :: ModuleName = 'UKCA_DERIV_MOD'

CONTAINS

SUBROUTINE ukca_deriv(nr, n_be_calls, n_pnts,                    &
                    rc, wdep, ddep, dj,                          &
                    h2o, m, o2,                                  &
                    dts, y)

USE ukca_option_mod, ONLY: jpspec, jppj, nit
USE yomhook, ONLY: lhook, dr_hook
USE parkind1, ONLY: jprb, jpim
USE UM_ParVars
IMPLICIT NONE


INTEGER, INTENT(IN) :: nr         ! No. reactions
INTEGER, INTENT(IN) :: n_be_calls ! No. chemical steps
INTEGER, INTENT(IN) :: n_pnts     ! Actual no. calculations

REAL, INTENT(IN)    :: dts                 ! timestep
REAL, INTENT(IN)    :: rc(n_pnts,nr)       ! rxn rate coeffs
REAL, INTENT(IN)    :: dj(n_pnts,jppj)     ! photol rates
REAL, INTENT(IN)    :: wdep(n_pnts,jpspec) ! wet dep rates
REAL, INTENT(IN)    :: ddep(n_pnts,jpspec) ! dry dep rates
REAL, INTENT(IN)    :: h2o(n_pnts)         ! h2o concn
REAL, INTENT(IN)    :: m(n_pnts)           ! air density
REAL, INTENT(IN)    :: o2(n_pnts)          ! o2 density

REAL, INTENT(INOUT) :: y(n_pnts,jpspec)    ! species concn

!     Local variables

INTEGER :: i, j, n                         ! loop variables

REAL :: p(n_pnts)                          ! production rate
REAL :: p1(n_pnts)                         ! working array
REAL :: p2(n_pnts)                         ! working array
REAL :: r1(n_pnts)                         ! working array
REAL :: r2(n_pnts)                         ! working array
REAL :: l(n_pnts)                          ! loss rate
REAL :: l1(n_pnts)                         ! working array
REAL :: l2(n_pnts)                         ! working array
REAL :: l3(n_pnts)                         ! working array
REAL :: yp(n_pnts,jpspec)                  ! previous species concn

INTEGER(KIND=jpim), PARAMETER :: zhook_in  = 0
INTEGER(KIND=jpim), PARAMETER :: zhook_out = 1
REAL(KIND=jprb)               :: zhook_handle

CHARACTER(LEN=*), PARAMETER :: RoutineName='UKCA_DERIV'

IF (lhook) CALL dr_hook(ModuleName//':'//RoutineName,zhook_in,zhook_handle)

DO n = 1, n_be_calls           ! loop over chemical timesteps

  DO j = 1,jpspec
    yp(:,j) = y(:,j)
  END DO

  !       Set constant fields

  yp(:,12) = 5.0e-7*m(:)     ! H2
  yp(:,16) = 350.0e-6*m(:)   ! CO2
  yp(:,19) = h2o(:)          ! H2O
  yp(:,22) = o2(:)           ! O2
  yp(:,23) = m(:) - o2(:)    ! N2

  y (:,12) = yp(:,12)        ! H2
  y (:,16) = yp(:,16)        ! CO2
  y (:,19) = yp(:,19)        ! H2O
  y (:,22) = yp(:,22)        ! O2
  y (:,23) = yp(:,23)        ! N2

  !       Iteration start

  DO i=1,nit                   ! loop over iterations

    !         O(3P)        Y( 1)

    p(:) = 0.0                                                   &
           +(dj(:,15) *y(:,3 ))                                  &
           +(dj(:,12) *y(:,5 ))        +(dj(:,13) *y(:,22)*2.00) &
           +(rc(:,76) *y(:,10)*y(:,10))+(dj(:,10) *y(:,6 ))      &
           +(rc(:,49) *y(:,2 )*y(:,23))                          &
           +(rc(:,50) *y(:,2 )*y(:,22))
    l(:) = ddep(:,1) + wdep(:,1)                                 &
           +(rc(:,44) *y(:,3 ))                                  &
           +(rc(:,83) *y(:,6 ))+(rc(:,96) *y(:,22))
    y(:, 1) = p(:)/l(:)

    !         O(1D)        Y( 2)

    p(:) = 0.0                                                   &
           +(dj(:,14) *y(:,3 ))
    l(:) = ddep(:,2) + wdep(:,2)                                 &
           +(rc(:,48) *y(:,19))+(rc(:,49) *y(:,23))              &
           +(rc(:,50) *y(:,22))                                  &
           +(rc(:,45) *y(:,14))+(rc(:,46) *y(:,14))              &
           +(rc(:,47) *y(:,14))
    y(:, 2) = p(:)/l(:)

    !         OH           Y(10)

    p(:) = 0.0                                                   &
           +(dj(:,1)  *y(:,34))        +(dj(:,1)  *y(:,39))      &
           +(dj(:,17) *y(:,21))        +(dj(:,1)  *y(:,33))      &
           +(dj(:,6)  *y(:,9 ))        +(dj(:,1)  *y(:,20))      &
           +(dj(:,1)  *y(:,26))        +(dj(:,2)  *y(:,13)*2.00) &
           +(rc(:,82) *y(:,10)*y(:,34))                          &
           +(rc(:,85) *y(:,45)*y(:,44))                          &
           +(rc(:,72) *y(:,10)*y(:,39))                          &
           +(rc(:,80) *y(:,10)*y(:,33))                          &
           +(rc(:,57) *y(:,10)*y(:,26))                          &
           +(rc(:,66) *y(:,10)*y(:,20))                          &
           +(rc(:,45) *y(:,2 )*y(:,14))                          &
           +(rc(:,48) *y(:,2 )*y(:,19)*2.00)                     &
           +(rc(:,3)  *y(:,11)*y(:,3 ))                          &
           +(rc(:,10) *y(:,11)*y(:,28))                          &
           +(rc(:,1)  *y(:,11)*y(:,4 ))                          &
           +(rc(:,2)  *y(:,11)*y(:,5 ))
    l(:) = ddep(:,10) + wdep(:,10)                               &
           +(rc(:,99) *y(:,10))                                  &
           +(rc(:,97) *y(:,4 ))+(rc(:,98) *y(:,6 ))              &
           +(rc(:,99) *y(:,10))                                  &
           +(rc(:,80) *y(:,33))+(rc(:,81) *y(:,34))              &
           +(rc(:,82) *y(:,34))                                  &
           +(rc(:,77) *y(:,29))+(rc(:,78) *y(:,40))              &
           +(rc(:,79) *y(:,33))                                  &
           +(rc(:,75) *y(:,3 ))+(rc(:,76) *y(:,10))              &
           +(rc(:,76) *y(:,10))                                  &
           +(rc(:,72) *y(:,39))+(rc(:,73) *y(:,27))              &
           +(rc(:,74) *y(:,5 ))                                  &
           +(rc(:,69) *y(:,37))+(rc(:,70) *y(:,37))              &
           +(rc(:,71) *y(:,39))                                  &
           +(rc(:,66) *y(:,20))+(rc(:,67) *y(:,20))              &
           +(rc(:,68) *y(:,41))                                  &
           +(rc(:,63) *y(:,8 ))+(rc(:,64) *y(:,9 ))              &
           +(rc(:,65) *y(:,21))                                  &
           +(rc(:,60) *y(:,13))+(rc(:,61) *y(:,17))              &
           +(rc(:,62) *y(:,11))                                  &
           +(rc(:,57) *y(:,26))+(rc(:,58) *y(:,26))              &
           +(rc(:,59) *y(:,12))                                  &
           +(rc(:,54) *y(:,30))+(rc(:,55) *y(:,15))              &
           +(rc(:,56) *y(:,35))                                  &
           +(rc(:,51) *y(:,14))+(rc(:,52) *y(:,24))              &
           +(rc(:,53) *y(:,30))
    y(:,10) = p(:)/l(:)

    !         O3           Y( 3)

    p(:) = 0.0                                                   &
           +(rc(:,96) *y(:,1 )*y(:,22))                          &
           +(rc(:,9)  *y(:,11)*y(:,28))                          &
           +(rc(:,14) *y(:,11)*y(:,36))
    l(:) = ddep(:,3) + wdep(:,3)                                 &
           +(dj(:,15) )                                          &
           +(rc(:,44) *y(:,1 ))                                  &
           +(rc(:,75) *y(:,10))+(dj(:,14) )                      &
           +(rc(:,3)  *y(:,11))+(rc(:,37) *y(:,4 ))              &
           +(rc(:,38) *y(:,6 ))
    y(:, 3) = (yp(:, 3)+dts*p(:))/(1.0+dts*l(:))

    !         NO           Y( 4)

    p(:) = 0.0                                                   &
           +(dj(:,11) *y(:,5 ))        +(dj(:,17) *y(:,21))      &
           +(rc(:,83) *y(:,1 )*y(:,6 ))+(dj(:,10) *y(:,6 ))
    l(:) = ddep(:,4) + wdep(:,4)                                 &
           +(rc(:,36) *y(:,5 ))+(rc(:,37) *y(:,3 ))              &
           +(rc(:,97) *y(:,10))                                  &
           +(rc(:,30) *y(:,32))+(rc(:,32) *y(:,36))              &
           +(rc(:,34) *y(:,38))                                  &
           +(rc(:,23) *y(:,25))+(rc(:,26) *y(:,28))              &
           +(rc(:,28) *y(:,31))                                  &
           +(rc(:,1)  *y(:,11))+(rc(:,16) *y(:,18))              &
           +(rc(:,17) *y(:,18))
    y(:, 4) = (yp(:, 4)+dts*p(:))/(1.0+dts*l(:))

    !         NO2          Y( 6)

    p(:) = 0.0                                                   &
           +(dj(:,20) *y(:,41))                                  &
           +(dj(:,16) *y(:,29))        +(dj(:,16) *y(:,40))      &
           +(dj(:,9)  *y(:,7 ))        +(dj(:,12) *y(:,5 ))      &
           +(dj(:,5)  *y(:,8 ))        +(dj(:,6)  *y(:,9 ))      &
           +(rc(:,94) *y(:,7 ))        +(rc(:,101)*y(:,40))      &
           +(rc(:,91) *y(:,8 ))        +(rc(:,93) *y(:,29))      &
           +(rc(:,77) *y(:,10)*y(:,29))                          &
           +(rc(:,78) *y(:,10)*y(:,40))                          &
           +(rc(:,68) *y(:,10)*y(:,41))                          &
           +(rc(:,74) *y(:,10)*y(:,5 ))                          &
           +(rc(:,63) *y(:,10)*y(:,8 ))                          &
           +(rc(:,65) *y(:,10)*y(:,21))                          &
           +(rc(:,36) *y(:,4 )*y(:,5 )*2.00)                     &
           +(rc(:,37) *y(:,4 )*y(:,3 ))                          &
           +(rc(:,34) *y(:,38)*y(:,4 ))                          &
           +(rc(:,35) *y(:,38)*y(:,5 ))                          &
           +(rc(:,32) *y(:,36)*y(:,4 ))                          &
           +(rc(:,33) *y(:,36)*y(:,5 ))                          &
           +(rc(:,30) *y(:,32)*y(:,4 ))                          &
           +(rc(:,31) *y(:,32)*y(:,5 ))                          &
           +(rc(:,28) *y(:,31)*y(:,4 ))                          &
           +(rc(:,29) *y(:,31)*y(:,5 ))                          &
           +(rc(:,26) *y(:,28)*y(:,4 ))                          &
           +(rc(:,27) *y(:,28)*y(:,5 ))                          &
           +(rc(:,23) *y(:,25)*y(:,4 ))                          &
           +(rc(:,24) *y(:,25)*y(:,5 ))                          &
           +(rc(:,16) *y(:,18)*y(:,4 ))                          &
           +(rc(:,18) *y(:,18)*y(:,5 ))                          &
           +(rc(:,1)  *y(:,11)*y(:,4 ))                          &
           +(rc(:,2)  *y(:,11)*y(:,5 ))
    l(:) = ddep(:,6) + wdep(:,6)                                 &
           +(rc(:,100)*y(:,36))+(dj(:,10) )                      &
           +(rc(:,92) *y(:,28))+(rc(:,95) *y(:,5 ))              &
           +(rc(:,98) *y(:,10))                                  &
           +(rc(:,38) *y(:,3 ))+(rc(:,83) *y(:,1 ))              &
           +(rc(:,90) *y(:,11))
    y(:, 6) = (yp(:, 6)+dts*p(:))/(1.0+dts*l(:))

    !         NO3/N2O5  Y(:, 5)/Y(:, 7)

    p1(:) = 0.0                                                  &
            +(rc(:,38) *y(:,6 )*y(:,3 ))                         &
            +(rc(:,64) *y(:,10)*y(:,9 ))
    l(:) = ddep(:,5) + wdep(:,5)                                 &
           +(dj(:,11) )        +(dj(:,12) )                      &
           +(rc(:,42) *y(:,37))+(rc(:,74) *y(:,10))              &
           +(rc(:,95) *y(:,6 ))                                  &
           +(rc(:,39) *y(:,17))+(rc(:,40) *y(:,27))              &
           +(rc(:,41) *y(:,35))                                  &
           +(rc(:,33) *y(:,36))+(rc(:,35) *y(:,38))              &
           +(rc(:,36) *y(:,4 ))                                  &
           +(rc(:,27) *y(:,28))+(rc(:,29) *y(:,31))              &
           +(rc(:,31) *y(:,32))                                  &
           +(rc(:,2)  *y(:,11))+(rc(:,18) *y(:,18))              &
           +(rc(:,24) *y(:,25))
    p2(:) = 0.0
    r1(:) = rc(:,94) + dj(:,9)
    r2(:) = rc(:,95) *y(:,6 )
    l1(:) = ddep(:,7) + wdep(:,7)                                &
            +(rc(:,43) *y(:,19))+(rc(:,94) )        +(dj(:,9)  )
    l2(:) = 1.0+l(:)*dts
    l3(:) = 1.0+l1(:)*dts
    y(:,5) = (l3(:)*(yp(:,5)+p1(:)*dts)+r1(:)*dts*yp(:,7))/      &
               ((l3(:)*l2(:))-r1(:)*r2(:)*dts**2)
    y(:,7) = (yp(:,7) + p2(:)*dts + r2(:)*dts*y(:,5))/l3(:)

    !         HO2NO2       Y( 8)

    p(:) = 0.0                                                   &
           +(rc(:,90) *y(:,11)*y(:,6 ))
    l(:) = ddep(:,8) + wdep(:,8)                                 &
           +(rc(:,63) *y(:,10))+(rc(:,91) )        +(dj(:,5)  )
    y(:, 8) = (yp(:, 8)+dts*p(:))/(1.0+dts*l(:))

    !         HONO2        Y( 9)

    p(:) = 0.0                                                   &
           +(rc(:,43) *y(:,7 )*y(:,19)*2.00)                     &
           +(rc(:,98) *y(:,10)*y(:,6 ))                          &
           +(rc(:,41) *y(:,5 )*y(:,35))                          &
           +(rc(:,42) *y(:,5 )*y(:,37))                          &
           +(rc(:,39) *y(:,5 )*y(:,17))                          &
           +(rc(:,40) *y(:,5 )*y(:,27))
    l(:) = ddep(:,9) + wdep(:,9)                                 &
           +(rc(:,64) *y(:,10))+(dj(:,6)  )
    y(:, 9) = (yp(:, 9)+dts*p(:))/(1.0+dts*l(:))

    !         HO2          Y(11)

    p(:) = 0.0                                                   &
           +(dj(:,1)  *y(:,34))        +(dj(:,20) *y(:,41))      &
           +(dj(:,18) *y(:,35))        +(dj(:,1)  *y(:,33))      &
           +(dj(:,7)  *y(:,27))        +(dj(:,1)  *y(:,20))      &
           +(dj(:,3)  *y(:,17)*2.00)        +(dj(:,5)  *y(:,8 )) &
           +(rc(:,91) *y(:,8 ))        +(dj(:,1)  *y(:,26))      &
           +(rc(:,75) *y(:,10)*y(:,3 ))                          &
           +(rc(:,84) *y(:,46)*y(:,44))                          &
           +(rc(:,61) *y(:,10)*y(:,17))                          &
           +(rc(:,74) *y(:,10)*y(:,5 ))                          &
           +(rc(:,59) *y(:,10)*y(:,12))                          &
           +(rc(:,60) *y(:,10)*y(:,13))                          &
           +(rc(:,47) *y(:,2 )*y(:,14)*2.00)                     &
           +(rc(:,55) *y(:,10)*y(:,15))                          &
           +(rc(:,31) *y(:,32)*y(:,5 ))                          &
           +(rc(:,39) *y(:,5 )*y(:,17))                          &
           +(rc(:,29) *y(:,31)*y(:,5 ))                          &
           +(rc(:,30) *y(:,32)*y(:,4 ))                          &
           +(rc(:,25) *y(:,25)*y(:,28))                          &
           +(rc(:,28) *y(:,31)*y(:,4 ))                          &
           +(rc(:,23) *y(:,25)*y(:,4 ))                          &
           +(rc(:,24) *y(:,25)*y(:,5 ))                          &
           +(rc(:,20) *y(:,18)*y(:,18)*2.00)                     &
           +(rc(:,21) *y(:,18)*y(:,28))                          &
           +(rc(:,16) *y(:,18)*y(:,4 ))                          &
           +(rc(:,18) *y(:,18)*y(:,5 ))
    l(:) = ddep(:,11) + wdep(:,11)                               &
           +(rc(:,89) *y(:,11))+(rc(:,90) *y(:,6 ))              &
           +(rc(:,15) *y(:,38))+(rc(:,62) *y(:,10))              &
           +(rc(:,89) *y(:,11))                                  &
           +(rc(:,12) *y(:,32))+(rc(:,13) *y(:,36))              &
           +(rc(:,14) *y(:,36))                                  &
           +(rc(:,9)  *y(:,28))+(rc(:,10) *y(:,28))              &
           +(rc(:,11) *y(:,31))                                  &
           +(rc(:,6)  *y(:,18))+(rc(:,7)  *y(:,25))              &
           +(rc(:,8)  *y(:,28))                                  &
           +(rc(:,4)  *y(:,11))+(rc(:,4)  *y(:,11))              &
           +(rc(:,5)  *y(:,18))                                  &
           +(rc(:,1)  *y(:,4 ))+(rc(:,2)  *y(:,5 ))              &
           +(rc(:,3)  *y(:,3 ))
    y(:,11) = (yp(:,11)+dts*p(:))/(1.0+dts*l(:))

    !         H2O2         Y(13)

    p(:) = 0.0                                                   &
           +(rc(:,99) *y(:,10)*y(:,10))                          &
           +(rc(:,4)  *y(:,11)*y(:,11))                          &
           +(rc(:,89) *y(:,11)*y(:,11))
    l(:) = ddep(:,13) + wdep(:,13)                               &
           +(rc(:,60) *y(:,10))+(dj(:,2)  )
    y(:,13) = (yp(:,13)+dts*p(:))/(1.0+dts*l(:))

    !         CH4          Y(14)

    p(:) = 0.0                                                   &
           +(dj(:,8)  *y(:,27))
    l(:) = ddep(:,14) + wdep(:,14)                               &
           +(rc(:,51) *y(:,10))                                  &
           +(rc(:,45) *y(:,2 ))+(rc(:,46) *y(:,2 ))              &
           +(rc(:,47) *y(:,2 ))
    y(:,14) = (yp(:,14)+dts*p(:))/(1.0+dts*l(:))

    !         CO           Y(15)

    p(:) = 0.0                                                   &
           +(dj(:,18) *y(:,35))                                  &
           +(dj(:,7)  *y(:,27))        +(dj(:,8)  *y(:,27))      &
           +(dj(:,3)  *y(:,17))        +(dj(:,4)  *y(:,17))      &
           +(rc(:,39) *y(:,5 )*y(:,17))                          &
           +(rc(:,61) *y(:,10)*y(:,17))
    l(:) = ddep(:,15) + wdep(:,15)                               &
           +(rc(:,55) *y(:,10))
    y(:,15) = (yp(:,15)+dts*p(:))/(1.0+dts*l(:))

    !         HCHO         Y(17)

    p(:) = 0.0                                                   &
           +(dj(:,20) *y(:,41))                                  &
           +(dj(:,1)  *y(:,20))        +(dj(:,1)  *y(:,39))      &
           +(rc(:,68) *y(:,10)*y(:,41))                          &
           +(rc(:,77) *y(:,10)*y(:,29))                          &
           +(rc(:,47) *y(:,2 )*y(:,14))                          &
           +(rc(:,66) *y(:,10)*y(:,20))                          &
           +(rc(:,35) *y(:,38)*y(:,5 ))                          &
           +(rc(:,46) *y(:,2 )*y(:,14))                          &
           +(rc(:,22) *y(:,18)*y(:,28))                          &
           +(rc(:,34) *y(:,38)*y(:,4 ))                          &
           +(rc(:,20) *y(:,18)*y(:,18)*2.00)                     &
           +(rc(:,21) *y(:,18)*y(:,28))                          &
           +(rc(:,18) *y(:,18)*y(:,5 ))                          &
           +(rc(:,19) *y(:,18)*y(:,18))                          &
           +(rc(:,6)  *y(:,11)*y(:,18))                          &
           +(rc(:,16) *y(:,18)*y(:,4 ))
    l(:) = ddep(:,17) + wdep(:,17)                               &
           +(dj(:,4)  )                                          &
           +(rc(:,39) *y(:,5 ))+(rc(:,61) *y(:,10))+(dj(:,3)  )
    y(:,17) = (yp(:,17)+dts*p(:))/(1.0+dts*l(:))

    !         MeOO         Y(18)

    p(:) = 0.0                                                   &
           +(dj(:,7)  *y(:,27))        +(dj(:,19) *y(:,37))      &
           +(rc(:,51) *y(:,10)*y(:,14))                          &
           +(rc(:,67) *y(:,10)*y(:,20))                          &
           +(rc(:,27) *y(:,28)*y(:,5 ))                          &
           +(rc(:,45) *y(:,2 )*y(:,14))                          &
           +(rc(:,25) *y(:,25)*y(:,28))                          &
           +(rc(:,26) *y(:,28)*y(:,4 ))                          &
           +(rc(:,10) *y(:,11)*y(:,28))                          &
           +(rc(:,21) *y(:,18)*y(:,28))
    l(:) = ddep(:,18) + wdep(:,18)                               &
           +(rc(:,21) *y(:,28))+(rc(:,22) *y(:,28))              &
           +(rc(:,19) *y(:,18))+(rc(:,20) *y(:,18))              &
           +(rc(:,20) *y(:,18))                                  &
           +(rc(:,17) *y(:,4 ))+(rc(:,18) *y(:,5 ))              &
           +(rc(:,19) *y(:,18))                                  &
           +(rc(:,5)  *y(:,11))+(rc(:,6)  *y(:,11))              &
           +(rc(:,16) *y(:,4 ))
    y(:,18) = (yp(:,18)+dts*p(:))/(1.0+dts*l(:))

    !         MeOOH        Y(20)

    p(:) = 0.0                                                   &
           +(rc(:,5)  *y(:,11)*y(:,18))
    l(:) = ddep(:,20) + wdep(:,20)                               &
           +(rc(:,66) *y(:,10))+(rc(:,67) *y(:,10))+(dj(:,1)  )
    y(:,20) = (yp(:,20)+dts*p(:))/(1.0+dts*l(:))

    !         HONO         Y(21)

    p(:) = 0.0                                                   &
           +(rc(:,97) *y(:,10)*y(:,4 ))
    l(:) = ddep(:,21) + wdep(:,21)                               &
           +(rc(:,65) *y(:,10))+(dj(:,17) )
    y(:,21) = (yp(:,21)+dts*p(:))/(1.0+dts*l(:))

    !         C2H6         Y(24)

    p(:) = 0.0
    l(:) = ddep(:,24) + wdep(:,24)                               &
           +(rc(:,52) *y(:,10))
    y(:,24) = (yp(:,24)+dts*p(:))/(1.0+dts*l(:))

    !         EtOO         Y(25)

    p(:) = 0.0                                                   &
           +(dj(:,18) *y(:,35))                                  &
           +(rc(:,52) *y(:,10)*y(:,24))                          &
           +(rc(:,58) *y(:,10)*y(:,26))                          &
           +(rc(:,32) *y(:,36)*y(:,4 ))                          &
           +(rc(:,33) *y(:,36)*y(:,5 ))
    l(:) = ddep(:,25) + wdep(:,25)                               &
           +(rc(:,25) *y(:,28))                                  &
           +(rc(:,7)  *y(:,11))+(rc(:,23) *y(:,4 ))              &
           +(rc(:,24) *y(:,5 ))
    y(:,25) = (yp(:,25)+dts*p(:))/(1.0+dts*l(:))

    !         EtOOH        Y(26)

    p(:) = 0.0                                                   &
           +(rc(:,7)  *y(:,11)*y(:,25))
    l(:) = ddep(:,26) + wdep(:,26)                               &
           +(rc(:,57) *y(:,10))+(rc(:,58) *y(:,10))+(dj(:,1)  )
    y(:,26) = (yp(:,26)+dts*p(:))/(1.0+dts*l(:))

    !         MeCHO        Y(27)

    p(:) = 0.0                                                   &
           +(rc(:,78) *y(:,10)*y(:,40))+(dj(:,1)  *y(:,26))      &
           +(rc(:,25) *y(:,25)*y(:,28))                          &
           +(rc(:,57) *y(:,10)*y(:,26))                          &
           +(rc(:,23) *y(:,25)*y(:,4 ))                          &
           +(rc(:,24) *y(:,25)*y(:,5 ))
    l(:) = ddep(:,27) + wdep(:,27)                               &
           +(dj(:,8)  )                                          &
           +(rc(:,40) *y(:,5 ))+(rc(:,73) *y(:,10))+(dj(:,7)  )
    y(:,27) = (yp(:,27)+dts*p(:))/(1.0+dts*l(:))

    !         MeCO3        Y(28)

    p(:) = 0.0                                                   &
           +(dj(:,19) *y(:,37))        +(dj(:,1)  *y(:,39))      &
           +(rc(:,93) *y(:,29))        +(dj(:,16) *y(:,29))      &
           +(rc(:,40) *y(:,5 )*y(:,27))                          &
           +(rc(:,73) *y(:,10)*y(:,27))                          &
           +(rc(:,34) *y(:,38)*y(:,4 ))                          &
           +(rc(:,35) *y(:,38)*y(:,5 ))
    l(:) = ddep(:,28) + wdep(:,28)                               &
           +(rc(:,26) *y(:,4 ))+(rc(:,27) *y(:,5 ))              &
           +(rc(:,92) *y(:,6 ))                                  &
           +(rc(:,21) *y(:,18))+(rc(:,22) *y(:,18))              &
           +(rc(:,25) *y(:,25))                                  &
           +(rc(:,8)  *y(:,11))+(rc(:,9)  *y(:,11))              &
           +(rc(:,10) *y(:,11))
    y(:,28) = (yp(:,28)+dts*p(:))/(1.0+dts*l(:))

    !         PAN          Y(29)

    p(:) = 0.0                                                   &
           +(rc(:,92) *y(:,28)*y(:,6 ))
    l(:) = ddep(:,29) + wdep(:,29)                               &
           +(rc(:,77) *y(:,10))+(rc(:,93) )        +(dj(:,16) )
    y(:,29) = (yp(:,29)+dts*p(:))/(1.0+dts*l(:))

    !         C3H8         Y(30)

    p(:) = 0.0
    l(:) = ddep(:,30) + wdep(:,30)                               &
           +(rc(:,53) *y(:,10))+(rc(:,54) *y(:,10))
    y(:,30) = (yp(:,30)+dts*p(:))/(1.0+dts*l(:))

    !         n-PrOO       Y(31)

    p(:) = 0.0                                                   &
           +(rc(:,53) *y(:,10)*y(:,30))                          &
           +(rc(:,79) *y(:,10)*y(:,33))
    l(:) = ddep(:,31) + wdep(:,31)                               &
           +(rc(:,11) *y(:,11))+(rc(:,28) *y(:,4 ))              &
           +(rc(:,29) *y(:,5 ))
    y(:,31) = (yp(:,31)+dts*p(:))/(1.0+dts*l(:))

    !         i-PrOO       Y(32)

    p(:) = 0.0                                                   &
           +(rc(:,54) *y(:,10)*y(:,30))                          &
           +(rc(:,81) *y(:,10)*y(:,34))
    l(:) = ddep(:,32) + wdep(:,32)                               &
           +(rc(:,12) *y(:,11))+(rc(:,30) *y(:,4 ))              &
           +(rc(:,31) *y(:,5 ))
    y(:,32) = (yp(:,32)+dts*p(:))/(1.0+dts*l(:))

    !         n-PrOOH      Y(33)

    p(:) = 0.0                                                   &
           +(rc(:,11) *y(:,11)*y(:,31))
    l(:) = ddep(:,33) + wdep(:,33)                               &
           +(rc(:,79) *y(:,10))+(rc(:,80) *y(:,10))+(dj(:,1)  )
    y(:,33) = (yp(:,33)+dts*p(:))/(1.0+dts*l(:))

    !         i-PrOOH      Y(34)

    p(:) = 0.0                                                   &
           +(rc(:,12) *y(:,11)*y(:,32))
    l(:) = ddep(:,34) + wdep(:,34)                               &
           +(rc(:,81) *y(:,10))+(rc(:,82) *y(:,10))+(dj(:,1)  )
    y(:,34) = (yp(:,34)+dts*p(:))/(1.0+dts*l(:))

    !         EtCHO        Y(35)

    p(:) = 0.0                                                   &
           +(rc(:,80) *y(:,10)*y(:,33))+(dj(:,1)  *y(:,33))      &
           +(rc(:,28) *y(:,31)*y(:,4 ))                          &
           +(rc(:,29) *y(:,31)*y(:,5 ))
    l(:) = ddep(:,35) + wdep(:,35)                               &
           +(rc(:,41) *y(:,5 ))                                  &
           +(rc(:,56) *y(:,10))+(dj(:,18) )
    y(:,35) = (yp(:,35)+dts*p(:))/(1.0+dts*l(:))

    !         EtCO3        Y(36)

    p(:) = 0.0                                                   &
           +(rc(:,101)*y(:,40))        +(dj(:,16) *y(:,40))      &
           +(rc(:,41) *y(:,5 )*y(:,35))                          &
           +(rc(:,56) *y(:,10)*y(:,35))
    l(:) = ddep(:,36) + wdep(:,36)                               &
           +(rc(:,33) *y(:,5 ))+(rc(:,100)*y(:,6 ))              &
           +(rc(:,13) *y(:,11))+(rc(:,14) *y(:,11))              &
           +(rc(:,32) *y(:,4 ))
    y(:,36) = (yp(:,36)+dts*p(:))/(1.0+dts*l(:))

    !         Me2CO        Y(37)

    p(:) = 0.0                                                   &
           +(rc(:,82) *y(:,10)*y(:,34))+(dj(:,1)  *y(:,34))      &
           +(rc(:,30) *y(:,32)*y(:,4 ))                          &
           +(rc(:,31) *y(:,32)*y(:,5 ))
    l(:) = ddep(:,37) + wdep(:,37)                               &
           +(dj(:,19) )                                          &
           +(rc(:,42) *y(:,5 ))+(rc(:,69) *y(:,10))              &
           +(rc(:,70) *y(:,10))
    y(:,37) = (yp(:,37)+dts*p(:))/(1.0+dts*l(:))

    !         MeCOCH2O     Y(38)

    p(:) = 0.0                                                   &
           +(rc(:,70) *y(:,10)*y(:,37))                          &
           +(rc(:,71) *y(:,10)*y(:,39))                          &
           +(rc(:,42) *y(:,5 )*y(:,37))                          &
           +(rc(:,69) *y(:,10)*y(:,37))
    l(:) = ddep(:,38) + wdep(:,38)                               &
           +(rc(:,15) *y(:,11))+(rc(:,34) *y(:,4 ))              &
           +(rc(:,35) *y(:,5 ))
    y(:,38) = (yp(:,38)+dts*p(:))/(1.0+dts*l(:))

    !         MeCOCH2O     Y(39)

    p(:) = 0.0                                                   &
           +(rc(:,15) *y(:,11)*y(:,38))
    l(:) = ddep(:,39) + wdep(:,39)                               &
           +(rc(:,71) *y(:,10))+(rc(:,72) *y(:,10))+(dj(:,1)  )
    y(:,39) = (yp(:,39)+dts*p(:))/(1.0+dts*l(:))

    !         PPAN         Y(40)

    p(:) = 0.0                                                   &
           +(rc(:,100)*y(:,36)*y(:,6 ))
    l(:) = ddep(:,40) + wdep(:,40)                               &
           +(rc(:,78) *y(:,10))+(rc(:,101))        +(dj(:,16) )
    y(:,40) = (yp(:,40)+dts*p(:))/(1.0+dts*l(:))

    !         MeONO2       Y(41)

    p(:) = 0.0                                                   &
           +(rc(:,17) *y(:,18)*y(:,4 ))
    l(:) = ddep(:,41) + wdep(:,41)                               &
           +(rc(:,68) *y(:,10))+(dj(:,20) )
    y(:,41) = (yp(:,41)+dts*p(:))/(1.0+dts*l(:))

    !         O(3P)S       Y(42)

    p(:) = 0.0                                                   &
           +(dj(:,15) *y(:,44))                                  &
           +(rc(:,87) *y(:,43)*y(:,23))                          &
           +(rc(:,88) *y(:,43)*y(:,22))
    l(:) = ddep(:,42) + wdep(:,42)                               &
           +(rc(:,102)*y(:,22))
    y(:,42) = (yp(:,42)+dts*p(:))/(1.0+dts*l(:))

    !         O(1D)S       Y(43)

    p(:) = 0.0                                                   &
           +(dj(:,14) *y(:,44))
    l(:) = ddep(:,43) + wdep(:,43)                               &
           +(rc(:,86) *y(:,19))+(rc(:,87) *y(:,23))              &
           +(rc(:,88) *y(:,22))
    y(:,43) = (yp(:,43)+dts*p(:))/(1.0+dts*l(:))

    !         O3S          Y(44)

    p(:) = 0.0                                                   &
           +(rc(:,102)*y(:,42)*y(:,22))
    l(:) = ddep(:,44) + wdep(:,44)                               &
           +(dj(:,15) )                                          &
           +(rc(:,84) *y(:,46))+(rc(:,85) *y(:,45))+(dj(:,14) )
    y(:,44) = (yp(:,44)+dts*p(:))/(1.0+dts*l(:))

    !         OHS          Y(45)

    p(:) = 0.0
    l(:) = ddep(:,45) + wdep(:,45)                               &
           +(rc(:,85) *y(:,44))
    y(:,45) = (yp(:,45)+dts*p(:))/(1.0+dts*l(:))

    !         HO2S         Y(46)

    p(:) = 0.0
    l(:) = ddep(:,46) + wdep(:,46)                               &
           +(rc(:,84) *y(:,44))
    y(:,46) = (yp(:,46)+dts*p(:))/(1.0+dts*l(:))

  END DO ! End of iteration loop stop

END DO  ! n_be_calls

IF (lhook) CALL dr_hook(ModuleName//':'//RoutineName,zhook_out,zhook_handle)
RETURN
END SUBROUTINE ukca_deriv
END MODULE ukca_deriv_mod
