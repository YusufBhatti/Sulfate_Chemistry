! *****************************COPYRIGHT*******************************
! (C) Crown copyright Met Office. All rights reserved.
! For further details please refer to the file COPYRIGHT.txt
! which you should have received as part of this distribution.
! *****************************COPYRIGHT*******************************
!
!  Description:
!    To evaluate concentrations from rate coefficients, J values,
!    and dry and wet deposition rates.
!
!  UKCA is a community model supported by The Met Office and
!  NCAS, with components initially provided by The University of
!  Cambridge, University of Leeds and The Met Office. See
!  www.ukca.ac.uk
!
! Code Owner: Please refer to the UM file CodeOwners.txt
! This file belongs in section: UKCA
!
!  Code Description:
!    Language:  FORTRAN 90
!
! ######################################################################
!
MODULE ukca_deriv_aero_mod

IMPLICIT NONE

CHARACTER(LEN=*), PARAMETER, PRIVATE :: ModuleName = 'UKCA_DERIV_AERO_MOD'

CONTAINS

SUBROUTINE ukca_deriv_aero(nr_therm, nr_phot, n_be_calls,         &
                           rc, wdep, ddep,                        &
                           dj, k_dms, h2o, m, o2,                 &
                           dts, y,                                &
                           delta_SO2_wetox_H2O2,                  &
                           delta_SO2_wetox_O3,                    &
                           delta_SO2_dryox_OH)

USE ukca_option_mod, ONLY: jpspec, jppj, nit
USE parkind1, ONLY: jprb, jpim
USE yomhook, ONLY: lhook, dr_hook
USE UM_ParVars
USE nlsizes_namelist_mod, ONLY: &
    theta_field_size

IMPLICIT NONE


INTEGER, INTENT(IN) :: nr_therm      ! No of thermal reactions
INTEGER, INTENT(IN) :: nr_phot       ! No of photolytic reactions
INTEGER, INTENT(IN) :: n_be_calls    ! No diagnostics

REAL, INTENT(IN) :: rc(theta_field_size,nr_therm)   ! Rate coeffs
REAL, INTENT(IN) :: wdep(theta_field_size,jpspec)   ! Wet dep rates
REAL, INTENT(IN) :: ddep(theta_field_size,jpspec)   ! Dry dep rates
REAL, INTENT(IN) :: dj(theta_field_size,jppj)       ! Phot rates
REAL, INTENT(IN) :: k_dms(theta_field_size,5)       ! DMS rate coeffs
REAL, INTENT(IN) :: h2o(theta_field_size)           ! H2O
REAL, INTENT(IN) :: m(theta_field_size)             ! Air density
REAL, INTENT(IN) :: o2(theta_field_size)            ! Oxygen
REAL, INTENT(IN) :: dts                   ! timestep

! Species concentrations
REAL, INTENT(INOUT) :: y(theta_field_size,jpspec)

! Fluxes of SO2 by oxidation pathway
REAL, INTENT(OUT) :: delta_SO2_wetox_H2O2(theta_field_size)
REAL, INTENT(OUT) :: delta_SO2_wetox_O3(theta_field_size)
REAL, INTENT(OUT) :: delta_SO2_dryox_OH(theta_field_size)

! Local variables
REAL :: p1(theta_field_size)        ! Production and loss terms
REAL :: p2(theta_field_size)
REAL :: p(theta_field_size)
REAL :: l(theta_field_size)
REAL :: l1(theta_field_size)
REAL :: l2(theta_field_size)
REAL :: l3(theta_field_size)
REAL :: r1(theta_field_size)
REAL :: r2(theta_field_size)
REAL :: f_so2(theta_field_size)     ! fraction of dms to SO2
REAL :: f_so4(theta_field_size)     ! fraction of dms to SO4
REAL :: f_msa(theta_field_size)     ! fraction of dms to MSA
REAL :: yp(theta_field_size,jpspec) ! initial concentrations

INTEGER :: i,j,n              ! loop counters

INTEGER(KIND=jpim), PARAMETER :: zhook_in  = 0
INTEGER(KIND=jpim), PARAMETER :: zhook_out = 1
REAL(KIND=jprb)               :: zhook_handle

CHARACTER(LEN=*), PARAMETER :: RoutineName='UKCA_DERIV_AERO'

IF (lhook) CALL dr_hook(ModuleName//':'//RoutineName,zhook_in,zhook_handle)

! Initialise sulphur oxidation fluxes
delta_SO2_wetox_H2O2(:) = 0.0
delta_SO2_wetox_O3(:) = 0.0
delta_SO2_dryox_OH(:) = 0.0

DO n = 1, n_be_calls

  DO j = 1,jpspec
    DO i = 1, theta_field_size
      yp(i,j) = y(i,j)
    END DO
  END DO

  !      Set constant fields

  yp(:,12) = 5.0e-7*m(:)     ! H2
  yp(:,16) = 350.0e-6*m(:)   ! CO2
  yp(:,19) = h2o(:)          ! H2O
  yp(:,22) = o2(:)           ! O2
  yp(:,23) = m(:) - o2(:)    ! N2

  y (:,12) = yp(:,12)        ! H2
  y (:,16) = yp(:,16)        ! CO2
  y (:,19) = yp(:,19)        ! H2O
  y (:,22) = yp(:,22)        ! O2
  y (:,23) = yp(:,23)        ! N2


  ! Iteration start
  DO i=1,nit

    !
    !   This section written automatically by MECH9GEN from the file ukca_tropch3
    !   with 129 equations and 46 species.
    !
    !          O(3P)        Y( 1)
    p(:) =                                                            &
    +(dj(:,15) *y(:,3 ))                                              &
    +(dj(:,12) *y(:,5 ))        +(dj(:,13) *y(:,22)*2.00)             &
    +(rc(:,76) *y(:,10)*y(:,10))+(dj(:,10) *y(:,6 ))                  &
    +(rc(:,49) *y(:,2 )*y(:,23))+(rc(:,50) *y(:,2 )*y(:,22))
    l(:) = ddep(:,1) + wdep(:,1)                                      &
    +(rc(:,44) *y(:,3 ))+(rc(:,83) *y(:,6 ))+(rc(:,96) *y(:,22))
    y(:, 1) = p(:)/l(:)
    !
    !          O(1D)        Y( 2)
    p(:) =                                                            &
    +(dj(:,14) *y(:,3 ))
    l(:) = ddep(:,2) + wdep(:,2)                                      &
    +(rc(:,48) *y(:,19))+(rc(:,49) *y(:,23))+(rc(:,50) *y(:,22))      &
    +(rc(:,45) *y(:,14))+(rc(:,46) *y(:,14))+(rc(:,47) *y(:,14))
    y(:, 2) = p(:)/l(:)
    !
    !          OH           Y(10)
    p(:) =                                                            &
    +(dj(:,1)  *y(:,34))        +(dj(:,1)  *y(:,39))                  &
    +(dj(:,17) *y(:,21))        +(dj(:,1)  *y(:,33))                  &
    +(dj(:,6)  *y(:,9 ))        +(dj(:,1)  *y(:,20))                  &
    +(dj(:,1)  *y(:,26))        +(dj(:,2)  *y(:,13)*2.00)             &
    +(rc(:,82) *y(:,10)*y(:,34))+(rc(:,85) *y(:,45)*y(:,44))          &
    +(rc(:,72) *y(:,10)*y(:,39))+(rc(:,80) *y(:,10)*y(:,33))          &
    +(rc(:,57) *y(:,10)*y(:,26))+(rc(:,66) *y(:,10)*y(:,20))          &
    +(rc(:,45) *y(:,2 )*y(:,14))+(rc(:,48) *y(:,2 )*y(:,19)*2.00)     &
    +(rc(:,3)  *y(:,11)*y(:,3 ))+(rc(:,10) *y(:,11)*y(:,28))          &
    +(rc(:,1)  *y(:,11)*y(:,4 ))+(rc(:,2)  *y(:,11)*y(:,5 ))
    l(:) = ddep(:,10) + wdep(:,10)                                    &
    +(rc(:,99) *y(:,10))                                              &
    +(rc(:,97) *y(:,4 ))+(rc(:,98) *y(:,6 ))+(rc(:,99) *y(:,10))      &
    +(rc(:,80) *y(:,33))+(rc(:,81) *y(:,34))+(rc(:,82) *y(:,34))      &
    +(rc(:,77) *y(:,29))+(rc(:,78) *y(:,40))+(rc(:,79) *y(:,33))      &
    +(rc(:,75) *y(:,3 ))+(rc(:,76) *y(:,10))+(rc(:,76) *y(:,10))      &
    +(rc(:,72) *y(:,39))+(rc(:,73) *y(:,27))+(rc(:,74) *y(:,5 ))      &
    +(rc(:,69) *y(:,37))+(rc(:,70) *y(:,37))+(rc(:,71) *y(:,39))      &
    +(rc(:,66) *y(:,20))+(rc(:,67) *y(:,20))+(rc(:,68) *y(:,41))      &
    +(rc(:,63) *y(:,8 ))+(rc(:,64) *y(:,9 ))+(rc(:,65) *y(:,21))      &
    +(rc(:,60) *y(:,13))+(rc(:,61) *y(:,17))+(rc(:,62) *y(:,11))      &
    +(rc(:,57) *y(:,26))+(rc(:,58) *y(:,26))+(rc(:,59) *y(:,12))      &
    +(rc(:,54) *y(:,30))+(rc(:,55) *y(:,15))+(rc(:,56) *y(:,35))      &
    +(rc(:,51) *y(:,14))+(rc(:,52) *y(:,24))+(rc(:,53) *y(:,30))      &
    +(rc(:,103)*y(:,48))+(rc(:,111)*y(:,51))+(rc(:,112)*y(:,52))      &
    +(rc(:,105)*y(:,47))+(rc(:,106)*y(:,47))
    y(:,10) = p(:)/l(:)
    !
    !          O3           Y( 3)
    p(:) =                                                            &
    +(rc(:,96) *y(:,1 )*y(:,22))                                      &
    +(rc(:,9)  *y(:,11)*y(:,28))+(rc(:,14) *y(:,11)*y(:,36))
    l(:) = ddep(:,3) + wdep(:,3)                                      &
    +(dj(:,15) )                                                      &
    +(rc(:,44) *y(:,1 ))+(rc(:,75) *y(:,10))+(dj(:,14) )              &
    +(rc(:,3)  *y(:,11))+(rc(:,37) *y(:,4 ))+(rc(:,38) *y(:,6 ))      &
    +(rc(:,115)*y(:,48))+(rc(:,113)*y(:,52))
    y(:, 3) = (yp(:, 3)+dts*p(:))/(1.0+dts*l(:))
    !
    !          NO           Y( 4)
    p(:) =                                                            &
    +(dj(:,11) *y(:,5 ))        +(dj(:,17) *y(:,21))                  &
    +(rc(:,83) *y(:,1 )*y(:,6 ))+(dj(:,10) *y(:,6 ))                  &
    -(rc(:,111)*y(:,51)*y(:,10))     ! from NH3+OH
    l(:) = ddep(:,4) + wdep(:,4)                                      &
    +(rc(:,36) *y(:,5 ))+(rc(:,37) *y(:,3 ))+(rc(:,97) *y(:,10))      &
    +(rc(:,30) *y(:,32))+(rc(:,32) *y(:,36))+(rc(:,34) *y(:,38))      &
    +(rc(:,23) *y(:,25))+(rc(:,26) *y(:,28))+(rc(:,28) *y(:,31))      &
    +(rc(:,1)  *y(:,11))+(rc(:,16) *y(:,18))+(rc(:,17) *y(:,18))
    y(:, 4) = (yp(:, 4)+dts*p(:))/(1.0+dts*l(:))
    !
    !          NO2          Y( 6)
    p(:) =                                                            &
    +(dj(:,20) *y(:,41))                                              &
    +(dj(:,16) *y(:,29))        +(dj(:,16) *y(:,40))                  &
    +(dj(:,9)  *y(:,7 ))        +(dj(:,12) *y(:,5 ))                  &
    +(dj(:,5)  *y(:,8 ))        +(dj(:,6)  *y(:,9 ))                  &
    +(rc(:,94) *y(:,7 ))        +(rc(:,101)*y(:,40))                  &
    +(rc(:,91) *y(:,8 ))        +(rc(:,93) *y(:,29))                  &
    +(rc(:,77) *y(:,10)*y(:,29))+(rc(:,78) *y(:,10)*y(:,40))          &
    +(rc(:,68) *y(:,10)*y(:,41))+(rc(:,74) *y(:,10)*y(:,5 ))          &
    +(rc(:,63) *y(:,10)*y(:,8 ))+(rc(:,65) *y(:,10)*y(:,21))          &
    +(rc(:,36) *y(:,4 )*y(:,5 )*2.00)+(rc(:,37) *y(:,4 )*y(:,3 ))     &
    +(rc(:,34) *y(:,38)*y(:,4 ))+(rc(:,35) *y(:,38)*y(:,5 ))          &
    +(rc(:,32) *y(:,36)*y(:,4 ))+(rc(:,33) *y(:,36)*y(:,5 ))          &
    +(rc(:,30) *y(:,32)*y(:,4 ))+(rc(:,31) *y(:,32)*y(:,5 ))          &
    +(rc(:,28) *y(:,31)*y(:,4 ))+(rc(:,29) *y(:,31)*y(:,5 ))          &
    +(rc(:,26) *y(:,28)*y(:,4 ))+(rc(:,27) *y(:,28)*y(:,5 ))          &
    +(rc(:,23) *y(:,25)*y(:,4 ))+(rc(:,24) *y(:,25)*y(:,5 ))          &
    +(rc(:,16) *y(:,18)*y(:,4 ))+(rc(:,18) *y(:,18)*y(:,5 ))          &
    +(rc(:,1)  *y(:,11)*y(:,4 ))+(rc(:,2)  *y(:,11)*y(:,5 ))
    l(:) = ddep(:,6) + wdep(:,6)                                      &
    +(rc(:,100)*y(:,36))+(dj(:,10) )                                  &
    +(rc(:,92) *y(:,28))+(rc(:,95) *y(:,5 ))+(rc(:,98) *y(:,10))      &
    +(rc(:,38) *y(:,3 ))+(rc(:,83) *y(:,1 ))+(rc(:,90) *y(:,11))
    y(:, 6) = (yp(:, 6)+dts*p(:))/(1.0+dts*l(:))
    !
    !          NO3          Y( 5)
    !      P(:) =
    !     &+(RC(:,94) *Y(:,7 ))        +(DJ(:,9)  *Y(:,7 ))
    !     &+(RC(:,38) *Y(:,6 )*Y(:,3 ))+(RC(:,64) *Y(:,10)*Y(:,9 ))
    !      L(:) = DDEP(:,5) + WDEP(:,5)
    !     &+(DJ(:,11) )        +(DJ(:,12) )
    !     &+(RC(:,42) *Y(:,37))+(RC(:,74) *Y(:,10))+(RC(:,95) *Y(:,6 ))
    !     &+(RC(:,39) *Y(:,17))+(RC(:,40) *Y(:,27))+(RC(:,41) *Y(:,35))
    !     &+(RC(:,33) *Y(:,36))+(RC(:,35) *Y(:,38))+(RC(:,36) *Y(:,4 ))
    !     &+(RC(:,27) *Y(:,28))+(RC(:,29) *Y(:,31))+(RC(:,31) *Y(:,32))
    !     &+(RC(:,2)  *Y(:,11))+(RC(:,18) *Y(:,18))+(RC(:,24) *Y(:,25))
    !     &+(RC(:,107) *Y(:,47))
    !      Y(:, 5) = (YP(:, 5)+DTS*P(:))/(1.0+DTS*L(:))
    !
    !          N2O5         Y( 7)
    !      P(:) =
    !     &+(RC(:,95) *Y(:,6 )*Y(:,5 ))
    !      L(:) = DDEP(:,7) + WDEP(:,7)
    !     &+(RC(:,43) *Y(:,19))+(RC(:,94) )        +(DJ(:,9)  )
    !      Y(:, 7) = (YP(:, 7)+DTS*P(:))/(1.0+DTS*L(:))
    !
    !        NO3/N2O5  Y(:, 5)/Y(:, 7)
    p1(:) =                                                          &
   +(rc(:,38) *y(:,6 )*y(:,3 ))+(rc(:,64) *y(:,10)*y(:,9 ))
    l(:) = ddep(:,5) + wdep(:,5)                                     &
   +(dj(:,11) )        +(dj(:,12) )                                  &
   +(rc(:,42) *y(:,37))+(rc(:,74) *y(:,10))+(rc(:,95) *y(:,6 ))      &
   +(rc(:,39) *y(:,17))+(rc(:,40) *y(:,27))+(rc(:,41) *y(:,35))      &
   +(rc(:,33) *y(:,36))+(rc(:,35) *y(:,38))+(rc(:,36) *y(:,4 ))      &
   +(rc(:,27) *y(:,28))+(rc(:,29) *y(:,31))+(rc(:,31) *y(:,32))      &
   +(rc(:,2)  *y(:,11))+(rc(:,18) *y(:,18))+(rc(:,24) *y(:,25))      &
   +(rc(:,107)*y(:,47))+(rc(:,114)*y(:,52))
    p2(:) = 0.0
    r1(:) = rc(:,94) + dj(:,9)
    r2(:) = rc(:,95) *y(:,6 )
    l1(:) = ddep(:,7) + wdep(:,7)                                     &
    +(rc(:,43) *y(:,19))+(rc(:,94) )        +(dj(:,9)  )
    l2(:) = 1.0+l(:)*dts
    l3(:) = 1.0+l1(:)*dts
    y(:,5) = (l3(:)*(yp(:,5)+p1(:)*dts)+r1(:)*dts*yp(:,7))/           &
           ((l3(:)*l2(:))-r1(:)*r2(:)*dts**2)
    y(:,7) = (yp(:,7) + p2(:)*dts + r2(:)*dts*y(:,5))/l3(:)
    !
    !          HO2NO2       Y( 8)
    p(:) =                                                            &
    +(rc(:,90) *y(:,11)*y(:,6 ))
    l(:) = ddep(:,8) + wdep(:,8)                                      &
    +(rc(:,63) *y(:,10))+(rc(:,91) )        +(dj(:,5)  )
    y(:, 8) = (yp(:, 8)+dts*p(:))/(1.0+dts*l(:))
    !
    !          HONO2        Y( 9)
    p(:) =                                                            &
    +(rc(:,43) *y(:,7 )*y(:,19)*2.00)+(rc(:,98) *y(:,10)*y(:,6 ))     &
    +(rc(:,41) *y(:,5 )*y(:,35))+(rc(:,42) *y(:,5 )*y(:,37))          &
    +(rc(:,39) *y(:,5 )*y(:,17))+(rc(:,40) *y(:,5 )*y(:,27))          &
    +(rc(:,107)*y(:,5 )*y(:,47))
    l(:) = ddep(:,9) + wdep(:,9)                                      &
    +(rc(:,64) *y(:,10))+(dj(:,6)  )
    y(:, 9) = (yp(:, 9)+dts*p(:))/(1.0+dts*l(:))
    !
    !          HO2          Y(11)
    p(:) =                                                            &
    +(dj(:,1)  *y(:,34))        +(dj(:,20) *y(:,41))                  &
    +(dj(:,18) *y(:,35))        +(dj(:,1)  *y(:,33))                  &
    +(dj(:,7)  *y(:,27))        +(dj(:,1)  *y(:,20))                  &
    +(dj(:,3)  *y(:,17)*2.00)        +(dj(:,5)  *y(:,8 ))             &
    +(rc(:,91) *y(:,8 ))        +(dj(:,1)  *y(:,26))                  &
    +(rc(:,75) *y(:,10)*y(:,3 ))+(rc(:,84) *y(:,46)*y(:,44))          &
    +(rc(:,61) *y(:,10)*y(:,17))+(rc(:,74) *y(:,10)*y(:,5 ))          &
    +(rc(:,59) *y(:,10)*y(:,12))+(rc(:,60) *y(:,10)*y(:,13))          &
    +(rc(:,47) *y(:,2 )*y(:,14)*2.00)+(rc(:,55) *y(:,10)*y(:,15))     &
    +(rc(:,31) *y(:,32)*y(:,5 ))+(rc(:,39) *y(:,5 )*y(:,17))          &
    +(rc(:,29) *y(:,31)*y(:,5 ))+(rc(:,30) *y(:,32)*y(:,4 ))          &
    +(rc(:,25) *y(:,25)*y(:,28))+(rc(:,28) *y(:,31)*y(:,4 ))          &
    +(rc(:,23) *y(:,25)*y(:,4 ))+(rc(:,24) *y(:,25)*y(:,5 ))          &
    +(rc(:,20) *y(:,18)*y(:,18)*2.00)+(rc(:,21) *y(:,18)*y(:,28))     &
    +(rc(:,16) *y(:,18)*y(:,4 ))+(rc(:,18) *y(:,18)*y(:,5 ))
    l(:) = ddep(:,11) + wdep(:,11)                                    &
    +(rc(:,89) *y(:,11))+(rc(:,90) *y(:,6 ))                          &
    +(rc(:,15) *y(:,38))+(rc(:,62) *y(:,10))+(rc(:,89) *y(:,11))      &
    +(rc(:,12) *y(:,32))+(rc(:,13) *y(:,36))+(rc(:,14) *y(:,36))      &
    +(rc(:,9)  *y(:,28))+(rc(:,10) *y(:,28))+(rc(:,11) *y(:,31))      &
    +(rc(:,6)  *y(:,18))+(rc(:,7)  *y(:,25))+(rc(:,8)  *y(:,28))      &
    +(rc(:,4)  *y(:,11))+(rc(:,4)  *y(:,11))+(rc(:,5)  *y(:,18))      &
    +(rc(:,1)  *y(:,4 ))+(rc(:,2)  *y(:,5 ))+(rc(:,3)  *y(:,3 ))
    y(:,11) = (yp(:,11)+dts*p(:))/(1.0+dts*l(:))
    !
    !          H2           Y(12)
    !      P(:) =                                                            &
    !     &+(RC(:,46) *Y(:,2 )*Y(:,14))+(DJ(:,4)  *Y(:,17))
    !      L(:) = DDEP(:,12) + WDEP(:,12)
    !     &+(RC(:,59) *Y(:,10))
    !      Y(:,12) = (YP(:,12)+DTS*P(:))/(1.0+DTS*L(:))
    y(:,12) = yp(:,12)
    !
    !          H2O2         Y(13)
    p(:) =                                                            &
    +(rc(:,99) *y(:,10)*y(:,10))                                      &
    +(rc(:,4)  *y(:,11)*y(:,11))+(rc(:,89) *y(:,11)*y(:,11))
    l(:) = ddep(:,13) + wdep(:,13)                                    &
    +(rc(:,60) *y(:,10))+(dj(:,2)  )                                  &
    +(rc(:,104)*y(:,48))
    y(:,13) = (yp(:,13)+dts*p(:))/(1.0+dts*l(:))
    !
    !          CH4          Y(14)
    p(:) =                                                            &
    +(dj(:,8)  *y(:,27))
    l(:) = ddep(:,14) + wdep(:,14)                                    &
    +(rc(:,51) *y(:,10))                                              &
    +(rc(:,45) *y(:,2 ))+(rc(:,46) *y(:,2 ))+(rc(:,47) *y(:,2 ))
    y(:,14) = (yp(:,14)+dts*p(:))/(1.0+dts*l(:))
    !
    !          CO           Y(15)
    p(:) =                                                            &
    +(dj(:,18) *y(:,35))                                              &
    +(dj(:,7)  *y(:,27))        +(dj(:,8)  *y(:,27))                  &
    +(dj(:,3)  *y(:,17))        +(dj(:,4)  *y(:,17))                  &
    +(rc(:,39) *y(:,5 )*y(:,17))+(rc(:,61) *y(:,10)*y(:,17))
    l(:) = ddep(:,15) + wdep(:,15)                                    &
    +(rc(:,55) *y(:,10))
    y(:,15) = (yp(:,15)+dts*p(:))/(1.0+dts*l(:))
    !
    !          CO2          Y(16)
    !      P(:) =                                                            &
    !     &+(RC(:,32) *Y(:,36)*Y(:,4 ))+(RC(:,33) *Y(:,36)*Y(:,5 ))
    !     &+(RC(:,26) *Y(:,28)*Y(:,4 ))+(RC(:,27) *Y(:,28)*Y(:,5 ))
    !      L(:) = DDEP(:,16) + WDEP(:,16)
    y(:,16) = yp(:,16)
    !
    !          HCHO         Y(17)
    p(:) =                                                            &
    +(dj(:,20) *y(:,41))                                              &
    +(dj(:,1)  *y(:,20))        +(dj(:,1)  *y(:,39))                  &
    +(rc(:,68) *y(:,10)*y(:,41))+(rc(:,77) *y(:,10)*y(:,29))          &
    +(rc(:,47) *y(:,2 )*y(:,14))+(rc(:,66) *y(:,10)*y(:,20))          &
    +(rc(:,35) *y(:,38)*y(:,5 ))+(rc(:,46) *y(:,2 )*y(:,14))          &
    +(rc(:,22) *y(:,18)*y(:,28))+(rc(:,34) *y(:,38)*y(:,4 ))          &
    +(rc(:,20) *y(:,18)*y(:,18)*2.00)+(rc(:,21) *y(:,18)*y(:,28))     &
    +(rc(:,18) *y(:,18)*y(:,5 ))+(rc(:,19) *y(:,18)*y(:,18))          &
    +(rc(:,6)  *y(:,11)*y(:,18))+(rc(:,16) *y(:,18)*y(:,4 ))
    l(:) = ddep(:,17) + wdep(:,17)                                    &
    +(dj(:,4)  )                                                      &
    +(rc(:,39) *y(:,5 ))+(rc(:,61) *y(:,10))+(dj(:,3)  )
    y(:,17) = (yp(:,17)+dts*p(:))/(1.0+dts*l(:))
    !
    !          MeOO         Y(18)
    p(:) =                                                            &
    +(dj(:,7)  *y(:,27))        +(dj(:,19) *y(:,37))                  &
    +(rc(:,51) *y(:,10)*y(:,14))+(rc(:,67) *y(:,10)*y(:,20))          &
    +(rc(:,27) *y(:,28)*y(:,5 ))+(rc(:,45) *y(:,2 )*y(:,14))          &
    +(rc(:,25) *y(:,25)*y(:,28))+(rc(:,26) *y(:,28)*y(:,4 ))          &
    +(rc(:,10) *y(:,11)*y(:,28))+(rc(:,21) *y(:,18)*y(:,28))
    l(:) = ddep(:,18) + wdep(:,18)                                    &
    +(rc(:,21) *y(:,28))+(rc(:,22) *y(:,28))                          &
    +(rc(:,19) *y(:,18))+(rc(:,20) *y(:,18))+(rc(:,20) *y(:,18))      &
    +(rc(:,17) *y(:,4 ))+(rc(:,18) *y(:,5 ))+(rc(:,19) *y(:,18))      &
    +(rc(:,5)  *y(:,11))+(rc(:,6)  *y(:,11))+(rc(:,16) *y(:,4 ))
    y(:,18) = (yp(:,18)+dts*p(:))/(1.0+dts*l(:))
    !
    !          H2O          Y(19)
    !      P(:) =                                                            &
    !     &+(RC(:,81) *Y(:,10)*Y(:,34))+(RC(:,86) *Y(:,43)*Y(:,19))          &
    !     &+(RC(:,79) *Y(:,10)*Y(:,33))+(RC(:,80) *Y(:,10)*Y(:,33))          &
    !     &+(RC(:,77) *Y(:,10)*Y(:,29))+(RC(:,78) *Y(:,10)*Y(:,40))          &
    !     &+(RC(:,73) *Y(:,10)*Y(:,27))+(RC(:,76) *Y(:,10)*Y(:,10))          &
    !     &+(RC(:,70) *Y(:,10)*Y(:,37))+(RC(:,71) *Y(:,10)*Y(:,39))          &
    !     &+(RC(:,68) *Y(:,10)*Y(:,41))+(RC(:,69) *Y(:,10)*Y(:,37))          &
    !     &+(RC(:,66) *Y(:,10)*Y(:,20))+(RC(:,67) *Y(:,10)*Y(:,20))          &
    !     &+(RC(:,64) *Y(:,10)*Y(:,9 ))+(RC(:,65) *Y(:,10)*Y(:,21))          &
    !     &+(RC(:,62) *Y(:,10)*Y(:,11))+(RC(:,63) *Y(:,10)*Y(:,8 ))          &
    !     &+(RC(:,60) *Y(:,10)*Y(:,13))+(RC(:,61) *Y(:,10)*Y(:,17))          &
    !     &+(RC(:,58) *Y(:,10)*Y(:,26))+(RC(:,59) *Y(:,10)*Y(:,12))          &
    !     &+(RC(:,56) *Y(:,10)*Y(:,35))+(RC(:,57) *Y(:,10)*Y(:,26))          &
    !     &+(RC(:,53) *Y(:,10)*Y(:,30))+(RC(:,54) *Y(:,10)*Y(:,30))          &
    !     &+(RC(:,51) *Y(:,10)*Y(:,14))+(RC(:,52) *Y(:,10)*Y(:,24))
    !      L(:) = DDEP(:,19) + WDEP(:,19)                                    &
    !     &+(RC(:,43) *Y(:,7 ))+(RC(:,48) *Y(:,2 ))+(RC(:,86) *Y(:,43))
    y(:,19) = yp(:,19)
    !
    !          MeOOH        Y(20)
    p(:) =                                                            &
    +(rc(:,5)  *y(:,11)*y(:,18))
    l(:) = ddep(:,20) + wdep(:,20)                                    &
    +(rc(:,66) *y(:,10))+(rc(:,67) *y(:,10))+(dj(:,1)  )
    y(:,20) = (yp(:,20)+dts*p(:))/(1.0+dts*l(:))
    !
    !          HONO         Y(21)
    p(:) =                                                            &
    +(rc(:,97) *y(:,10)*y(:,4 ))
    l(:) = ddep(:,21) + wdep(:,21)                                    &
    +(rc(:,65) *y(:,10))+(dj(:,17) )
    y(:,21) = (yp(:,21)+dts*p(:))/(1.0+dts*l(:))
    !
    !          O2           Y(22)
    !      P(:) =                                                            &
    !     &+(DJ(:,15) *Y(:,44))
    !     &+(DJ(:,15) *Y(:,3 ))        +(DJ(:,14) *Y(:,44))
    !     &+(DJ(:,11) *Y(:,5 ))        +(DJ(:,14) *Y(:,3 ))
    !     &+(RC(:,88) *Y(:,43)*Y(:,22))+(RC(:,89) *Y(:,11)*Y(:,11))
    !     &+(RC(:,84) *Y(:,46)*Y(:,44))+(RC(:,85) *Y(:,45)*Y(:,44))
    !     &+(RC(:,75) *Y(:,10)*Y(:,3 ))+(RC(:,83) *Y(:,1 )*Y(:,6 ))
    !     &+(RC(:,44) *Y(:,1 )*Y(:,3 )*2.00)+(RC(:,50) *Y(:,2 )*Y(:,22))
    !     &+(RC(:,3)  *Y(:,11)*Y(:,3 ))+(RC(:,13) *Y(:,11)*Y(:,36))
    !      L(:) = DDEP(:,22) + WDEP(:,22)
    !     &+(RC(:,102)*Y(:,42))+(DJ(:,13) )
    !     &+(RC(:,50) *Y(:,2 ))+(RC(:,88) *Y(:,43))+(RC(:,96) *Y(:,1 ))
    y(:,22) = yp(:,22)
    !
    !          N2           Y(23)
    !      P(:) =                                                            &
    !     &+(RC(:,49) *Y(:,2 )*Y(:,23))+(RC(:,87) *Y(:,43)*Y(:,23))
    !      L(:) = DDEP(:,23) + WDEP(:,23)
    !     &+(RC(:,49) *Y(:,2 ))+(RC(:,87) *Y(:,43))
    y(:,23) = yp(:,23)
    !
    !          C2H6         Y(24)
    p(:) = 0.0
    l(:) = ddep(:,24) + wdep(:,24)                                    &
    +(rc(:,52) *y(:,10))
    y(:,24) = (yp(:,24)+dts*p(:))/(1.0+dts*l(:))
    !
    !          EtOO         Y(25)
    p(:) =                                                            &
    +(dj(:,18) *y(:,35))                                              &
    +(rc(:,52) *y(:,10)*y(:,24))+(rc(:,58) *y(:,10)*y(:,26))          &
    +(rc(:,32) *y(:,36)*y(:,4 ))+(rc(:,33) *y(:,36)*y(:,5 ))
    l(:) = ddep(:,25) + wdep(:,25)                                    &
    +(rc(:,25) *y(:,28))                                              &
    +(rc(:,7)  *y(:,11))+(rc(:,23) *y(:,4 ))+(rc(:,24) *y(:,5 ))
    y(:,25) = (yp(:,25)+dts*p(:))/(1.0+dts*l(:))
    !
    !          EtOOH        Y(26)
    p(:) =                                                            &
    +(rc(:,7)  *y(:,11)*y(:,25))
    l(:) = ddep(:,26) + wdep(:,26)                                    &
    +(rc(:,57) *y(:,10))+(rc(:,58) *y(:,10))+(dj(:,1)  )
    y(:,26) = (yp(:,26)+dts*p(:))/(1.0+dts*l(:))
    !
    !          MeCHO        Y(27)
    p(:) =                                                            &
    +(rc(:,78) *y(:,10)*y(:,40))+(dj(:,1)  *y(:,26))                  &
    +(rc(:,25) *y(:,25)*y(:,28))+(rc(:,57) *y(:,10)*y(:,26))          &
    +(rc(:,23) *y(:,25)*y(:,4 ))+(rc(:,24) *y(:,25)*y(:,5 ))
    l(:) = ddep(:,27) + wdep(:,27)                                    &
    +(dj(:,8)  )                                                      &
    +(rc(:,40) *y(:,5 ))+(rc(:,73) *y(:,10))+(dj(:,7)  )
    y(:,27) = (yp(:,27)+dts*p(:))/(1.0+dts*l(:))
    !
    !          MeCO3        Y(28)
    p(:) =                                                            &
    +(dj(:,19) *y(:,37))        +(dj(:,1)  *y(:,39))                  &
    +(rc(:,93) *y(:,29))        +(dj(:,16) *y(:,29))                  &
    +(rc(:,40) *y(:,5 )*y(:,27))+(rc(:,73) *y(:,10)*y(:,27))          &
    +(rc(:,34) *y(:,38)*y(:,4 ))+(rc(:,35) *y(:,38)*y(:,5 ))
    l(:) = ddep(:,28) + wdep(:,28)                                    &
    +(rc(:,26) *y(:,4 ))+(rc(:,27) *y(:,5 ))+(rc(:,92) *y(:,6 ))      &
    +(rc(:,21) *y(:,18))+(rc(:,22) *y(:,18))+(rc(:,25) *y(:,25))      &
    +(rc(:,8)  *y(:,11))+(rc(:,9)  *y(:,11))+(rc(:,10) *y(:,11))
    y(:,28) = (yp(:,28)+dts*p(:))/(1.0+dts*l(:))
    !
    !          PAN          Y(29)
    p(:) =                                                            &
    +(rc(:,92) *y(:,28)*y(:,6 ))
    l(:) = ddep(:,29) + wdep(:,29)                                    &
    +(rc(:,77) *y(:,10))+(rc(:,93) )        +(dj(:,16) )
    y(:,29) = (yp(:,29)+dts*p(:))/(1.0+dts*l(:))
    !
    !          C3H8         Y(30)
    p(:) = 0.0
    l(:) = ddep(:,30) + wdep(:,30)                                    &
    +(rc(:,53) *y(:,10))+(rc(:,54) *y(:,10))
    y(:,30) = (yp(:,30)+dts*p(:))/(1.0+dts*l(:))
    !
    !          n-PrOO       Y(31)
    p(:) =                                                            &
    +(rc(:,53) *y(:,10)*y(:,30))+(rc(:,79) *y(:,10)*y(:,33))
    l(:) = ddep(:,31) + wdep(:,31)                                    &
    +(rc(:,11) *y(:,11))+(rc(:,28) *y(:,4 ))+(rc(:,29) *y(:,5 ))
    y(:,31) = (yp(:,31)+dts*p(:))/(1.0+dts*l(:))
    !
    !          i-PrOO       Y(32)
    p(:) =                                                            &
    +(rc(:,54) *y(:,10)*y(:,30))+(rc(:,81) *y(:,10)*y(:,34))
    l(:) = ddep(:,32) + wdep(:,32)                                    &
    +(rc(:,12) *y(:,11))+(rc(:,30) *y(:,4 ))+(rc(:,31) *y(:,5 ))
    y(:,32) = (yp(:,32)+dts*p(:))/(1.0+dts*l(:))
    !
    !          n-PrOOH      Y(33)
    p(:) =                                                            &
    +(rc(:,11) *y(:,11)*y(:,31))
    l(:) = ddep(:,33) + wdep(:,33)                                    &
    +(rc(:,79) *y(:,10))+(rc(:,80) *y(:,10))+(dj(:,1)  )
    y(:,33) = (yp(:,33)+dts*p(:))/(1.0+dts*l(:))
    !
    !          i-PrOOH      Y(34)
    p(:) =                                                            &
    +(rc(:,12) *y(:,11)*y(:,32))
    l(:) = ddep(:,34) + wdep(:,34)                                    &
    +(rc(:,81) *y(:,10))+(rc(:,82) *y(:,10))+(dj(:,1)  )
    y(:,34) = (yp(:,34)+dts*p(:))/(1.0+dts*l(:))
    !
    !          EtCHO        Y(35)
    p(:) =                                                            &
    +(rc(:,80) *y(:,10)*y(:,33))+(dj(:,1)  *y(:,33))                  &
    +(rc(:,28) *y(:,31)*y(:,4 ))+(rc(:,29) *y(:,31)*y(:,5 ))
    l(:) = ddep(:,35) + wdep(:,35)                                    &
    +(rc(:,41) *y(:,5 ))+(rc(:,56) *y(:,10))+(dj(:,18) )
    y(:,35) = (yp(:,35)+dts*p(:))/(1.0+dts*l(:))
    !
    !          EtCO3        Y(36)
    p(:) =                                                            &
    +(rc(:,101)*y(:,40))        +(dj(:,16) *y(:,40))                  &
    +(rc(:,41) *y(:,5 )*y(:,35))+(rc(:,56) *y(:,10)*y(:,35))
    l(:) = ddep(:,36) + wdep(:,36)                                    &
    +(rc(:,33) *y(:,5 ))+(rc(:,100)*y(:,6 ))                          &
    +(rc(:,13) *y(:,11))+(rc(:,14) *y(:,11))+(rc(:,32) *y(:,4 ))
    y(:,36) = (yp(:,36)+dts*p(:))/(1.0+dts*l(:))
    !
    !          Me2CO        Y(37)
    p(:) =                                                            &
    +(rc(:,82) *y(:,10)*y(:,34))+(dj(:,1)  *y(:,34))                  &
    +(rc(:,30) *y(:,32)*y(:,4 ))+(rc(:,31) *y(:,32)*y(:,5 ))
    l(:) = ddep(:,37) + wdep(:,37)                                    &
    +(dj(:,19) )                                                      &
    +(rc(:,42) *y(:,5 ))+(rc(:,69) *y(:,10))+(rc(:,70) *y(:,10))
    y(:,37) = (yp(:,37)+dts*p(:))/(1.0+dts*l(:))
    !
    !          MeCOCH2O     Y(38)
    p(:) =                                                            &
    +(rc(:,70) *y(:,10)*y(:,37))+(rc(:,71) *y(:,10)*y(:,39))          &
    +(rc(:,42) *y(:,5 )*y(:,37))+(rc(:,69) *y(:,10)*y(:,37))
    l(:) = ddep(:,38) + wdep(:,38)                                    &
    +(rc(:,15) *y(:,11))+(rc(:,34) *y(:,4 ))+(rc(:,35) *y(:,5 ))
    y(:,38) = (yp(:,38)+dts*p(:))/(1.0+dts*l(:))
    !
    !          MeCOCH2O     Y(39)
    p(:) =                                                            &
    +(rc(:,15) *y(:,11)*y(:,38))
    l(:) = ddep(:,39) + wdep(:,39)                                    &
    +(rc(:,71) *y(:,10))+(rc(:,72) *y(:,10))+(dj(:,1)  )
    y(:,39) = (yp(:,39)+dts*p(:))/(1.0+dts*l(:))
    !
    !          PPAN         Y(40)
    p(:) =                                                            &
    +(rc(:,100)*y(:,36)*y(:,6 ))
    l(:) = ddep(:,40) + wdep(:,40)                                    &
    +(rc(:,78) *y(:,10))+(rc(:,101))        +(dj(:,16) )
    y(:,40) = (yp(:,40)+dts*p(:))/(1.0+dts*l(:))
    !
    !          MeONO2       Y(41)
    p(:) =                                                            &
    +(rc(:,17) *y(:,18)*y(:,4 ))
    l(:) = ddep(:,41) + wdep(:,41)                                    &
    +(rc(:,68) *y(:,10))+(dj(:,20) )
    y(:,41) = (yp(:,41)+dts*p(:))/(1.0+dts*l(:))
    !
    !          O(3P)S       Y(42)
    p(:) =                                                            &
    +(dj(:,15) *y(:,44))                                              &
    +(rc(:,87) *y(:,43)*y(:,23))+(rc(:,88) *y(:,43)*y(:,22))
    l(:) = ddep(:,42) + wdep(:,42)                                    &
    +(rc(:,102)*y(:,22))
    y(:,42) = (yp(:,42)+dts*p(:))/(1.0+dts*l(:))
    !
    !          O(1D)S       Y(43)
    p(:) =                                                            &
    +(dj(:,14) *y(:,44))
    l(:) = ddep(:,43) + wdep(:,43)                                    &
    +(rc(:,86) *y(:,19))+(rc(:,87) *y(:,23))+(rc(:,88) *y(:,22))
    y(:,43) = (yp(:,43)+dts*p(:))/(1.0+dts*l(:))
    !
    !          O3S          Y(44)
    p(:) =                                                            &
    +(rc(:,102)*y(:,42)*y(:,22))
    l(:) = ddep(:,44) + wdep(:,44)                                    &
    +(dj(:,15) )                                                      &
    +(rc(:,84) *y(:,46))+(rc(:,85) *y(:,45))+(dj(:,14) )
    y(:,44) = (yp(:,44)+dts*p(:))/(1.0+dts*l(:))
    !
    !          OHS          Y(45)
    p(:) = 0.0
    l(:) = ddep(:,45) + wdep(:,45)                                    &
    +(rc(:,85) *y(:,44))
    y(:,45) = (yp(:,45)+dts*p(:))/(1.0+dts*l(:))
    !
    !          HO2S         Y(46)
    p(:) = 0.0
    l(:) = ddep(:,46) + wdep(:,46)                                    &
    +(rc(:,84) *y(:,44))
    y(:,46) = (yp(:,46)+dts*p(:))/(1.0+dts*l(:))
    !
    ! Fraction of DMS oxidation to products
    f_so2(:) = k_dms(:,1)/                                            &
               (k_dms(:,1)+k_dms(:,2)*y(:,3)+k_dms(:,3)*y(:,6))
    f_so4(:) = (1.0-f_so2)*k_dms(:,5)/(k_dms(:,5)+k_dms(:,4)*y(:,11))
    f_msa(:) = (1.0-f_so2)*k_dms(:,4)*y(:,11)/                        &
               (k_dms(:,5)+k_dms(:,4)*y(:,11))
    !
    !          DMS          Y(47)
    p(:) = 0.0
    l(:) = ddep(:,47) + wdep(:,47)                                    &
    +(rc(:,105) *y(:,10))+(rc(:,106) *y(:,10))                        &
    +(rc(:,107) *y(:,5))
    y(:,47) = (yp(:,47)+dts*p(:))/(1.0+dts*l(:))
    !
    !          SO2          Y(48)
    p(:) = 0.0                                                        &
    +(rc(:,105)*y(:,10)+rc(:,106)*y(:,10)                             &
    + rc(:,107)*y(:,5))*y(:,47)*f_so2(:)
    l(:) = 0.0 + ddep(:,48) + wdep(:,48)                              &
    +(rc(:,103) * y(:,10))+(rc(:,104) * y(:,13))                      &
    +(rc(:,115) * y(:,3))
    y(:,48) = (yp(:,48)+dts*p(:))/(1.0+dts*l(:))
    !
    !          H2SO4        Y(49)
    p(:) = 0.0                                                        &
    +(rc(:,103) * y(:,48) * y(:,10))                                  &
    +(rc(:,105)*y(:,10)+rc(:,106)*y(:,10)                             &
    + rc(:,107)*y(:,5))*y(:,47)*f_so4(:)
    l(:) = 0.0
    y(:,49) = (yp(:,49)+dts*p(:))/(1.0+dts*l(:))
    !
    !          MSA          Y(50)
    p(:) = 0.0                                                        &
    +(rc(:,105)*y(:,10)+rc(:,106)*y(:,10)                             &
    + rc(:,107)*y(:,5))*y(:,47)*f_msa(:)
    l(:) = 0.0
    y(:,50) = (yp(:,50)+dts*p(:))/(1.0+dts*l(:))

    !          NH3          Y(51)
    p(:) = 0.0
    l(:) = ddep(:,51) + wdep(:,51)                                    &
    +(rc(:,111) * y(:,10))
    y(:,51) = (yp(:,51)+dts*p(:))/(1.0+dts*l(:))

    !          Monoterp     Y(52)
    p(:) = 0.0
    l(:) = ddep(:,52)                                                 &
    +(rc(:,112) * y(:,10)) + (rc(:,113) * y(:,3))                     &
    +(rc(:,114) * y(:,5))
    y(:,52) = (yp(:,52)+dts*p(:))/(1.0+dts*l(:))

    !          Sec_Org      Y(53)
    p(:) = 0.0                                                        &
    +(rc(:,112)*y(:,52)*y(:,10)*0.13 + rc(:,113)*y(:,52)*y(:,3)*0.13) &
    +(rc(:,114)*y(:,52)*y(:,5)*0.13)
    l(:) = ddep(:,53) + wdep(:,53)
    y(:,53) = (yp(:,53)+dts*p(:))/(1.0+dts*l(:))

    !      iteration loop stop
  END DO

  ! Calculate flux terms at end of iteration.

  ! Fluxes to aqueous sulphate (always required for MODE):
  delta_SO2_wetox_H2O2(:)= delta_SO2_wetox_H2O2(:) +                &
                           rc(:,104)*y(:,13)*y(:,48)*dts
  delta_SO2_wetox_O3(:)  = delta_SO2_wetox_O3(:) +                  &
                           rc(:,115)*y(:,3)*y(:,48)*dts
  delta_SO2_dryox_OH(:)  = delta_SO2_dryox_OH(:) +                  &
                           rc(:,103)*y(:,10)*y(:,48)*dts

END DO  ! n_be_calls

IF (lhook) CALL dr_hook(ModuleName//':'//RoutineName,zhook_out,zhook_handle)
RETURN


END SUBROUTINE ukca_deriv_aero
END MODULE ukca_deriv_aero_mod
